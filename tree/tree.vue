<template>
  <div class="container" v-html="treeHtml">
    <div class="root-wrapper node-wrapper">
      <div class="node-layout">
        <div class="node-arrow iconfont icon-arrow-right"></div>
        <div class="node-entity">
          <div class="node-info">
            <span class="node-icon-box">
              <span class="iconfont icon-layout"></span>
            </span>
            <div class="node-name">Page</div>
            <div class="node-desc">.page</div>
          </div>
          <div class="handle-btn-box">
            <span class="iconfont icon-add"></span>
            <span class="iconfont icon-editor"></span>
            <span class="iconfont icon-trash"></span>
          </div>
        </div>
      </div>
      <div class="children-layout">
        <div class="node-wrapper">
          <div class="node-layout">
            <div class="node-arrow iconfont icon-arrow-right"></div>
            <div class="node-entity">
              <div class="node-info">
                <span class="node-icon-box">
                  <span class="iconfont icon-layout"></span>
                </span>
                <div class="node-name">Div</div>
                <div class="node-desc">.block</div>
              </div>
              <div class="handle-btn-box">
                <span class="iconfont icon-add"></span>
                <span class="iconfont icon-editor"></span>
                <span class="iconfont icon-trash"></span>
              </div>
            </div>
          </div>
          <div class="children-layout">
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-picture"></span>
                    </span>
                    <div class="node-name">Image</div>
                    <div class="node-desc">.img</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-text"></span>
                    </span>
                    <div class="node-name">Text</div>
                    <div class="node-desc">.txt</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="root-wrapper node-wrapper">
      <div class="node-layout">
        <div class="node-arrow iconfont icon-arrow-right"></div>
        <div class="node-entity">
          <div class="node-info">
            <span class="node-icon-box">
              <span class="iconfont icon-layout"></span>
            </span>
            <div class="node-name">Page</div>
            <div class="node-desc">.page</div>
          </div>
          <div class="handle-btn-box">
            <span class="iconfont icon-add"></span>
            <span class="iconfont icon-editor"></span>
            <span class="iconfont icon-trash"></span>
          </div>
        </div>
      </div>
      <div class="children-layout">
        <div class="node-wrapper">
          <div class="node-layout">
            <div class="node-arrow iconfont icon-arrow-right"></div>
            <div class="node-entity">
              <div class="node-info">
                <span class="node-icon-box">
                  <span class="iconfont icon-layout"></span>
                </span>
                <div class="node-name">Div</div>
                <div class="node-desc">.block</div>
              </div>
              <div class="handle-btn-box">
                <span class="iconfont icon-add"></span>
                <span class="iconfont icon-editor"></span>
                <span class="iconfont icon-trash"></span>
              </div>
            </div>
          </div>
          <div class="children-layout">
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-picture"></span>
                    </span>
                    <div class="node-name">Image</div>
                    <div class="node-desc">.img</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-text"></span>
                    </span>
                    <div class="node-name">Text</div>
                    <div class="node-desc">.txt</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="node-wrapper">
          <div class="node-layout">
            <div class="node-arrow iconfont icon-arrow-right"></div>
            <div class="node-entity">
              <div class="node-info">
                <span class="node-icon-box">
                  <span class="iconfont icon-layout"></span>
                </span>
                <div class="node-name">Div</div>
                <div class="node-desc">.block</div>
              </div>
              <div class="handle-btn-box">
                <span class="iconfont icon-add"></span>
                <span class="iconfont icon-editor"></span>
                <span class="iconfont icon-trash"></span>
              </div>
            </div>
          </div>
          <div class="children-layout">
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-picture"></span>
                    </span>
                    <div class="node-name">Image</div>
                    <div class="node-desc">.img</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="node-wrapper">
              <div class="node-layout">
                <div class="node-entity">
                  <div class="node-info">
                    <span class="node-icon-box">
                      <span class="iconfont icon-text"></span>
                    </span>
                    <div class="node-name">Text</div>
                    <div class="node-desc">.txt</div>
                  </div>
                  <div class="handle-btn-box">
                    <span class="iconfont icon-editor"></span>
                    <span class="iconfont icon-trash"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
//props:[]
//isLeaf
//
export default {
  name: "v-tree",
  props: {
    data: Array,
      nodeIconList:Array
  },
  data() {
    return {
      lastActiveNodeRef: null,
      treeHtml: ""
    };
  },
  methods: {
    nodeToHtml(node,isRoot,parentPos,index) {
      const hasChildren = !node.isLeaf && node.children;
      const currentPos = parentPos !== "" ? parentPos + '-' + index:index;
      return `
        <div class="node-wrapper ${isRoot ? `root-wrapper` : ``}">
          <div class="node-layout">
            ${
              hasChildren
                ? `<div class="node-arrow iconfont icon-arrow-right"></div>`
                : ``
            }
            <div class="node-entity">
              <div class="node-info" data-pos="${currentPos}">
                <span class="node-icon-box">
                  <span class="${
                    this.nodeIconList.find(
                      (nodeIcon) => nodeIcon.iconName === node.iconName
                    ).className
                  }"></span>
                </span>
                <div class="node-name">${node.name}</div>
                <div class="node-desc">${node.desc}</div>
              </div>
              <div class="handle-btn-box" data-pos="${currentPos}">
                ${hasChildren ? `<span class="iconfont icon-add"></span>` : ``}
                <span class="iconfont icon-editor"></span>
                <span class="iconfont icon-trash"></span>
              </div>
            </div>
          </div>
          ${
            hasChildren
              ? `<div class="children-layout">
                ${node.children
                  .map((childNode,childIndex) => {
                    return this.nodeToHtml(childNode,false,currentPos,childIndex);
                  })
                  .join("")}
              </div>`
              : ``
          }
        </div>
      `;
    },
    renderTree() {
      this.treeHtml = this.data.map((root,index) => this.nodeToHtml(root,true,"",index)).join("");
    },
  },
  mounted() {
    //注册事件侦听
    this.$el.addEventListener("click", (event) => {
      const targetClassList = event.target.classList;
      //expand events
      if (targetClassList.contains("node-arrow")) {
        event.target.classList.toggle("icon-arrow-right");
        event.target.classList.toggle("icon-arrow-down");
        const childPanelEle = event.target.parentElement.nextElementSibling;
        childPanelEle && childPanelEle.classList.toggle("expand");
      }
      //onSelect event
      if (targetClassList.contains("node-info")) {
        const targetEntityNode = event.target.parentElement;
        targetEntityNode.classList.toggle("active");
        this.lastActiveNodeRef &&
          this.lastActiveNodeRef.classList.remove("active");
        this.lastActiveNodeRef = targetEntityNode;
        this.$emit("onSelect",event.target.dataset.pos);
      }
      //node's btn clicked event
      if (targetClassList.contains("icon-editor")) {
        this.$emit("onModifyBtnClick",event.target.parentElement.dataset.pos);
      } else if (targetClassList.contains("icon-trash")) {
        this.$emit("onDeleteBtnClick",event.target.parentElement.dataset.pos);
      } else if (targetClassList.contains("icon-add")) {
        this.$emit("onAppendBtnClick",event.target.parentElement.dataset.pos);
      }
    });
    this.renderTree();
  },
};
</script>

<style scoped>
.container {
  margin: 20px;
}
@import url("./tree.css");
</style>
